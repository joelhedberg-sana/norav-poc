@page "/nurse"
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IConfiguration Cfg
@using System.Net.Http.Json

<h3>ECG Demographics â†’ Worklist (INI)</h3>

<EditForm Model="@m" OnValidSubmit="Submit" FormName="demoForm">
  <DataAnnotationsValidator />
  <ValidationSummary />
  <InputText @bind-Value="m.PatientId" placeholder="ID" />
  <InputText @bind-Value="m.LastName" placeholder="Last Name" />
  <InputText @bind-Value="m.FirstName" placeholder="First Name" />
  <InputNumber @bind-Value="m.BirthDay" placeholder="Birth Day" />
  <InputNumber @bind-Value="m.BirthMonth" placeholder="Birth Month" />
  <InputNumber @bind-Value="m.BirthYear" placeholder="Birth Year" />
  <InputNumber @bind-Value="m.Sex" placeholder="Sex (1=Male,2=Female)" />
  <InputNumber @bind-Value="m.Weight" placeholder="Weight" />
  <InputNumber @bind-Value="m.Height" placeholder="Height" />
  <InputText @bind-Value="m.Address" placeholder="Address" />
  <InputText @bind-Value="m.Phone1" placeholder="Phone1" />
  <InputText @bind-Value="m.Phone2" placeholder="Phone2" />
  <InputText @bind-Value="m.Fax" placeholder="Fax" />
  <InputText @bind-Value="m.Email" placeholder="E-Mail" />
  <InputText @bind-Value="m.Medications" placeholder="Medications" />
  <InputText @bind-Value="m.Other" placeholder="Other" />
  <button type="submit">Start Session</button>
  <button type="button" @onclick="SendToMwl">Send to MWL</button>
  <button type="button" @onclick="GetStatus">Status</button>
  <button type="button" @onclick="ClearSession">Clear Session</button>
</EditForm>

<p>@status</p>

@code {
  Demographics m = new() { BirthDay = 1, BirthMonth = 1, BirthYear = 1970 }; // defaults
  string status = "";
  public class Demographics
  {
    public string PatientId { get; set; } = "";
    public string LastName { get; set; } = "";
    public string FirstName { get; set; } = "";
    public int BirthDay { get; set; }
    public int BirthMonth { get; set; }
    public int BirthYear { get; set; }
    public int Sex { get; set; } = 1;
    public int Weight { get; set; }
    public int Height { get; set; }
    public string Address { get; set; } = "";
    public string Phone1 { get; set; } = "";
    public string Phone2 { get; set; } = "";
    public string Fax { get; set; } = "";
    public string Email { get; set; } = "";
    public string Medications { get; set; } = "";
    public string Other { get; set; } = "";
  }

  private async Task Submit()
  {
    var agent = Cfg["AgentUrl"]!;
    var resp = await Http.PostAsJsonAsync($"{agent}/session/start", m);
    status = await resp.Content.ReadAsStringAsync();
  }

  private async Task SendToMwl()
  {
    var agent = Cfg["AgentUrl"]!;
    var resp = await Http.PostAsJsonAsync($"{agent}/mwl/items", m);
    status = resp.IsSuccessStatusCode ? "MWL item added." : "MWL add failed.";
  }

  private async Task GetStatus()
  {
    var agent = Cfg["AgentUrl"]!;
    status = await Http.GetStringAsync($"{agent}/session/status");
  }

  private async Task ClearSession()
  {
    var agent = Cfg["AgentUrl"]!;
    var resp = await Http.PostAsync($"{agent}/session/clear", null);
    status = await resp.Content.ReadAsStringAsync();
  }
}
